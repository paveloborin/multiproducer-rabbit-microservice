# multiproducer-rabbit-microservice
Микросервис отправки сообщений в RabbitMQ поддерживающий полноценно concurrency, множество коллекторов и отложенную отправку в очередь.

Сервис состоит из набора коллекторов, продъюсера и кеша.
Основное назначение коллектора - собирать записи в базе, преобразовывать их в сообщения определенного формата  и отсылать в кеш.
Продьюсер собирает из кеша коллекцию сообщений, у которых наступило время обработки, и отсылает их в Реббит.

Основной фичей сервиса является динамическое создание коллекторов по описанию в конфигурации и отложенная обработка сообщения, т.е время передачи сообщения обработчику не завязано на время ее выборки из базы. 
Это позволяет реже запускать запросы на выборку из базы, задавать время обработки по какому-то внешнему сервису, а также контролировать время попадания сообщения из очереди в консьюмер с высокой точностью. 

Для реализации отложенной обработки добавлен кеш, с возможностью сортировки.

##Принцип работы
Файл конфигурации опрокидывается в программу в виде набора коллекторов, отличаюшихся названием, интервалом запуска, обработчиком, sql-запросом на выборку.
Коллекторы поднимают из базы сообщения формата: id/eventName/time/additionalParams. 
Сообщения попадают в канал коллектора. Каналы всех коллеторов сливаются в один.
Сообщения из общего канала разбираются в кеш. 

При наступлении времени обработки сообщения, оно пересылается из кеша в канал Продьюсера.
Продьюсер умеет пересылать сообщения в Реббит.

##Конфигурация
В директории config находятся поддиреткории development и production, которые определяют соответсвенно конфигурацию для dev и прода.
Среда разработки задается переменной окружения APP_ENV (например, APP_ENV=development).
В папке sql лежат запросы на выборку для коллеторов. На каждый запрос свой файл.

В основном файле конфигурации app.toml задаются настройки для соединения с бд, Rabbit, а также настройки коллекторов.

Список коллекторов определяется динамически на основе массива collectors.

Конфигурация  коллектора имеет следующий формат:

_handler = "Cancel"_ - название обработчика для событий отправляемых данным коллетором
_repeat_period = 1_ - переодичность выборки из базы в минутах
sql_query_file="./con**fig/sql/cancelByUserRequest.sql" - файл с запросом

collectors.cancel.params - массив дополнительных параметров, здесь могут быть любые параметры

##Run
Для работы с RabbitMq необходиома библиотека amqp. Зашрузить ее можно командой:
 
go get github.com/streadway/amqp

##Тестирование
Сервис зависит от двух внешних систем: базы данных и RabbitMq.

Запуск контейнера с RabbitMq для тестирования

docker run -d --hostname my-rabbit --name some-rabbit rabbitmq:3-management